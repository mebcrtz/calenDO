<!-- Edit Item Details Modal -->
<div class="modal fade" id="editItemDetailsModal" tabindex="-1" aria-labelledby="editItemDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 550px; height: auto;">
        <div class="modal-content" style="border-radius: 8px; border: none; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); height: auto; display: flex; flex-direction: column;">
            <!-- Modal Header -->
            <div class="modal-header" style="background-color: #1E4E9D; color: white; padding: 10px 15px;">
                <h5 class="modal-title" id="editItemDetailsModalLabel">Edit Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1); font-size: 1rem;"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body" style="padding: 15px 20px;">
                <form id="editItemDetailsForm" method="POST" action="">
                    {% csrf_token %}
                    <input type="hidden" name="item_id" id="editItemId">

                    <!-- Item Type -->
                    <div class="btn-group w-100 mb-3" role="group" aria-label="Event or Class">
                        <input type="radio" class="btn-check" name="itemType" id="editEvent" value="event">
                        <label class="btn btn-outline-primary" for="editEvent" style="color: #1E4E9D; border: 1px solid #1E4E9D; font-size: 0.8rem;">Event</label>

                        <input type="radio" class="btn-check" name="itemType" id="editClass" value="class">
                        <label class="btn btn-outline-primary" for="editClass" style="color: #1E4E9D; border: 1px solid #1E4E9D; font-size: 0.8rem;">Class</label>
                    </div>

                    <!-- Item Name -->
                    <div class="mb-2">
                        <label for="editItemName" class="form-label fw-bold" style="color: #1E4E9D; font-size: 0.8rem;">Item Name:</label>
                        <input type="text" class="form-control mx-auto" id="editItemName" name="itemName" style="border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; padding: 0.3rem; width: 100%; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);" required>
                    </div>

                    <!-- Occurrences -->
                    <div id="editTimeBlocks">
                        <label class="form-label" style="color: #1E4E9D; font-size: 0.8rem;">Days:</label>
                        <div class="d-flex justify-content-between mb-2">
                            <div class="text-center" style="width: calc(100% / 7);">
                                <label for="dayMonday" style="display: block; font-size: 0.8rem; color: #1E4E9D;">Monday</label>
                                <input class="form-check-input mt-1" type="checkbox" name="days[]" value="Monday" id="dayMonday">
                            </div>
                            <div class="text-center" style="width: calc(100% / 7);">
                                <label for="dayTuesday" style="display: block; font-size: 0.8rem; color: #1E4E9D;">Tuesday</label>
                                <input class="form-check-input mt-1" type="checkbox" name="days[]" value="Tuesday" id="dayTuesday">
                            </div>
                            <div class="text-center" style="width: calc(100% / 7);">
                                <label for="dayWednesday" style="display: block; font-size: 0.8rem; color: #1E4E9D;">Wednesday</label>
                                <input class="form-check-input mt-1" type="checkbox" name="days[]" value="Wednesday" id="dayWednesday">
                            </div>
                            <div class="text-center" style="width: calc(100% / 7);">
                                <label for="dayThursday" style="display: block; font-size: 0.8rem; color: #1E4E9D;">Thursday</label>
                                <input class="form-check-input mt-1" type="checkbox" name="days[]" value="Thursday" id="dayThursday">
                            </div>
                            <div class="text-center" style="width: calc(100% / 7);">
                                <label for="dayFriday" style="display: block; font-size: 0.8rem; color: #1E4E9D;">Friday</label>
                                <input class="form-check-input mt-1" type="checkbox" name="days[]" value="Friday" id="dayFriday">
                            </div>
                            <div class="text-center" style="width: calc(100% / 7);">
                                <label for="daySaturday" style="display: block; font-size: 0.8rem; color: #1E4E9D;">Saturday</label>
                                <input class="form-check-input mt-1" type="checkbox" name="days[]" value="Saturday" id="daySaturday">
                            </div>
                            <div class="text-center" style="width: calc(100% / 7);">
                                <label for="daySunday" style="display: block; font-size: 0.8rem; color: #1E4E9D;">Sunday</label>
                                <input class="form-check-input mt-1" type="checkbox" name="days[]" value="Sunday" id="daySunday">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6 mb-2">
                                <label for="startTime" class="form-label fw-bold" style="color: #1E4E9D; font-size: 0.8rem;">Start Time:</label>
                                <input type="time" class="form-control" id="startTime" name="startTime" style="border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);" required>
                            </div>
                            <div class="col-6 mb-2">
                                <label for="endTime" class="form-label fw-bold" style="color: #1E4E9D; font-size: 0.8rem;">End Time:</label>
                                <input type="time" class="form-control" id="endTime" name="endTime" style="border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);" required>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3 mt-2">
                        <label for="editNotes" class="form-label fw-bold" style="color: #1E4E9D; font-size: 0.8rem;">Notes:</label>
                        <input type="text" class="form-control" name="notes" id="editNotes" style="border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; width: 100%; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
                    </div>

                    <button type="button" class="btn mb-3" id="editAddTimeButton" style="background-color: white; color: #1E4E9D; font-size: 0.8rem; border: 2px solid #1E4E9D; border-radius: 10px;">
                        <i class="bi bi-plus-circle me-2"></i> Add Another Time
                    </button>
                </form>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer d-flex justify-content-end" style="padding: 15px 15px;">
                <button type="button" class="btn" style="border: 1px solid #1E4E9D; color: #1E4E9D; font-size: 0.8rem; border-radius: 10px;" data-bs-dismiss="modal">Close</button>
                <button type="submit" form="editItemDetailsForm" class="btn btn-primary btn-sm" style="background-color: #1E4E9D; font-size: 0.8rem; color: white; border: 5px solid #1E4E9D; border-radius: 10px;">
                    <i class="bi bi-save me-2"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>


<!-- JavaScript for Dynamic Time Blocks -->
<script>
    const scheduleSlug = "{{ schedule_slug }}";

    // Function to format time to HH:mm
    function formatTimeToHHMM(timeString) {
        if (!timeString) {
            console.error("Invalid time string:", timeString);
            return "";
        }

        const [time, modifier] = timeString.split(" ");
        let [hours, minutes] = time.split(":");

        if (!hours || !minutes || !modifier) {
            console.error("Unexpected time format:", timeString);
            return "";
        }

        if (modifier.toLowerCase() === "p.m." && hours !== "12") {
            hours = parseInt(hours, 10) + 12;
        }
        if (modifier.toLowerCase() === "a.m." && hours === "12") {
            hours = "00";
        }
        return `${hours.padStart(2, "0")}:${minutes}`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        let selectedButtonData = {};

        // Attach event listener to all edit buttons
        const editButtons = document.querySelectorAll('.edit-item-button');
        editButtons.forEach(button => {
            button.addEventListener('click', function () {
                // Store data from the clicked button
                selectedButtonData = {
                    itemId: this.getAttribute('data-item-id'),
                    itemName: this.getAttribute('data-item-name'),
                    occurrences: JSON.parse(this.getAttribute('data-occurrences') || '[]'),
                };

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editItemDetailsModal'));
                modal.show();
            });
        });

        // Attach `shown.bs.modal` event to the modal
        const modal = document.getElementById('editItemDetailsModal');
        modal.addEventListener('shown.bs.modal', function () {
            const form = document.getElementById('editItemDetailsForm');
            const startTime = document.getElementById('startTime');
            const endTime = document.getElementById('endTime');

            if (!form || !startTime || !endTime) {
                console.error("Form or Time fields not found in DOM!");
                return;
            }

            const { itemId, itemName, occurrences } = selectedButtonData;

            form.action = `/schedule/${scheduleSlug}/item/${itemId}/update/`;
            document.getElementById('editItemId').value = itemId;
            document.getElementById('editItemName').value = itemName;

            // Populate occurrences
            if (occurrences.length > 0) {
                const occurrence = occurrences[0];
                startTime.value = formatTimeToHHMM(occurrence.start_time);
                endTime.value = formatTimeToHHMM(occurrence.end_time);
            } else {
                startTime.value = "";
                endTime.value = "";
            }
        });
    });
</script>
