<!-- Edit Item Details Modal -->
<div class="modal fade" id="editItemDetailsModal" tabindex="-1" aria-labelledby="editItemDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="border: 2px solid #023D8A;">
            <div class="modal-header" style="background-color: #023D8A; color: white;">
                <h5 class="modal-title" id="editItemDetailsModalLabel">Edit Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="color: white;"></button>
            </div>
            <div class="modal-body">
                <form id="editItemDetailsForm" method="POST" action="">
                    {% csrf_token %}
                    <input type="hidden" name="item_id" id="editItemId">

                    <!-- Item Type -->
                    <div class="btn-group w-100 mb-3" role="group" aria-label="Event or Class">
                        <input type="radio" class="btn-check" name="itemType" id="editEvent" value="event">
                        <label class="btn btn-outline-primary" style="color: #023D8A; border: 1px solid #023D8A;" for="editEvent">Event</label>

                        <input type="radio" class="btn-check" name="itemType" id="editClass" value="class">
                        <label class="btn btn-outline-primary" style="color: #023D8A; border: 1px solid #023D8A;" for="editClass">Class</label>
                    </div>

                    <!-- Item Name -->
                    <div class="mb-3">
                        <label for="editItemName" class="form-label">Item Name:</label>
                        <input type="text" class="form-control" id="editItemName" name="itemName" required>
                    </div>

                    <!-- Item Type -->
                    <div class="mb-3">
                        <label for="editItemType" class="form-label">Type:</label>
                        <select class="form-select" id="editItemType" name="itemType" required>
                            <option value="event">Event</option>
                            <option value="class">Class</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="editItemNotes" class="form-label">Notes:</label>
                        <textarea class="form-control" id="editItemNotes" name="notes" rows="3"></textarea>
                    </div>

                    <!-- Occurrences -->
                    <h6>Occurrences:</h6>
                    <div id="editTimeBlocks">
                        <label class="form-label">Days:</label>
                        <div class="mb-2">
                            <label class="form-check-inline">
                                <input class="form-check-input" type="checkbox" name="days[]" value="Monday" id="dayMonday">
                                Monday
                            </label>
                            <label class="form-check-inline">
                                <input class="form-check-input" type="checkbox" name="days[]" value="Tuesday" id="dayTuesday">
                                Tuesday
                            </label>
                            <label class="form-check-inline">
                                <input class="form-check-input" type="checkbox" name="days[]" value="Wednesday" id="dayWednesday">
                                Wednesday
                            </label>
                            <label class="form-check-inline">
                                <input class="form-check-input" type="checkbox" name="days[]" value="Thursday" id="dayThursday">
                                Thursday
                            </label>
                            <label class="form-check-inline">
                                <input class="form-check-input" type="checkbox" name="days[]" value="Friday" id="dayFriday">
                                Friday
                            </label>
                            <label class="form-check-inline">
                                <input class="form-check-input" type="checkbox" name="days[]" value="Saturday" id="daySaturday">
                                Saturday
                            </label>
                            <label class="form-check-inline">
                                <input class="form-check-input" type="checkbox" name="days[]" value="Sunday" id="daySunday">
                                Sunday
                            </label>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label for="startTime" class="form-label">Start Time:</label>
                                <input type="time" class="form-control" id="startTime" name="startTime" required>
                            </div>
                            <div class="col">
                                <label for="endTime" class="form-label">End Time:</label>
                                <input type="time" class="form-control" id="endTime" name="endTime" required>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn mb-3" id="editAddTimeButton" style="background-color: #023D8A; color: white;">Add Another Time</button>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Notes:</label>
                        <textarea class="form-control" name="notes" id="editNotes" rows="3">{{ item.notes }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" style="border: 1px solid #023D8A; color: #023D8A;" data-bs-dismiss="modal">Close</button>
                <button type="submit" form="editItemDetailsForm" class="btn" style="background-color: #023D8A; color: white;">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Dynamic Time Blocks -->
<script>
    const scheduleSlug = "{{ schedule_slug }}";

    // Function to format time to HH:mm
    function formatTimeToHHMM(timeString) {
        if (!timeString) return "";

        const [time, modifier] = timeString.split(" ");
        let [hours, minutes] = time.split(":");

        if (!hours || !minutes || !modifier) return "";

        if (modifier.toLowerCase() === "p.m." && hours !== "12") {
            hours = parseInt(hours, 10) + 12;
        }
        if (modifier.toLowerCase() === "a.m." && hours === "12") {
            hours = "00";
        }
        return `${hours.padStart(2, "0")}:${minutes}`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        let selectedButtonData = {};

        // Attach event listener to all edit buttons
        const editButtons = document.querySelectorAll('.edit-item-button');
        editButtons.forEach(button => {
            button.addEventListener('click', function () {
                selectedButtonData = {
                    itemId: this.getAttribute('data-item-id'),
                    itemName: this.getAttribute('data-item-name'),
                    occurrences: JSON.parse(this.getAttribute('data-occurrences') || '[]'),
                };

                const modal = new bootstrap.Modal(document.getElementById('editItemDetailsModal'));
                modal.show();
            });
        });

        const modal = document.getElementById('editItemDetailsModal');
        modal.addEventListener('shown.bs.modal', function () {
            const form = document.getElementById('editItemDetailsForm');
            const startTime = document.getElementById('startTime');
            const endTime = document.getElementById('endTime');

            const { itemId, itemName, occurrences } = selectedButtonData;

            form.action = `/schedule/${scheduleSlug}/item/${itemId}/update/`;
            document.getElementById('editItemId').value = itemId;
            document.getElementById('editItemName').value = itemName;

            // Populate occurrences
            if (occurrences.length > 0) {
                const occurrence = occurrences[0];
                startTime.value = formatTimeToHHMM(occurrence.start_time);
                endTime.value = formatTimeToHHMM(occurrence.end_time);
            } else {
                startTime.value = "";
                endTime.value = "";
            }
        });

        // Handle "Add Another Time" button click
        const addTimeButton = document.getElementById('editAddTimeButton');
        const timeBlocksContainer = document.getElementById('editTimeBlocks');

        addTimeButton.addEventListener('click', function () {
            // Create a new row for time input fields
            const newTimeBlock = document.createElement('div');
            newTimeBlock.classList.add('row', 'mt-2');

            newTimeBlock.innerHTML = `
                <div class="col">
                    <label for="startTime" class="form-label">Start Time:</label>
                    <input type="time" class="form-control" name="startTime" required>
                </div>
                <div class="col">
                    <label for="endTime" class="form-label">End Time:</label>
                    <input type="time" class="form-control" name="endTime" required>
                </div>
                <div class="col-auto d-flex align-items-end">
                    <button type="button" class="btn btn-danger remove-time-block">Remove</button>
                </div>
            `;

            timeBlocksContainer.appendChild(newTimeBlock);

            // Add event listener to remove button
            newTimeBlock.querySelector('.remove-time-block').addEventListener('click', function () {
                newTimeBlock.remove();
            });
        });
    });
</script>